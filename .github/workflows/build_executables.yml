name: Build Executables

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
        # Ensure streamlit hook is available or updated if necessary
        # We install the app dependencies so PyInstaller can find them

    - name: Build Installer (bear-installer)
      run: |
        pyinstaller --onefile --clean \
          --name bear-installer \
          bear_installer.py

    - name: Build Launcher (bear-hub)
      run: |
        # We need to collect streamlit runtime and our app files
        # --collect-all streamlit might be needed if hooks fail, but usually auto-detected
        # We add our specific files

        pyinstaller --onefile --clean \
          --name bear-hub \
          --add-data "BEAR-HUB.py:." \
          --add-data "utils.py:." \
          --add-data "pages:pages" \
          --add-data "static:static" \
          --collect-all streamlit \
          --collect-all altair \
          --collect-all pandas \
          --collect-all pyyaml \
          bear_launcher.py

    - name: Test Executables (Smoke Test)
      run: |
        # Verify they were created
        ls -lh dist/

        # Test installer help/version if possible (it might try to run interactive logic)
        # We can't fully run them because they expect interaction or env setup,
        # but we can check if they start without immediate crash (e.g. import errors).
        # However, bear-installer runs logic immediately. bear-hub launches streamlit server.
        # So we just verify file existence for now.
        if [ ! -f dist/bear-installer ]; then echo "bear-installer missing"; exit 1; fi
        if [ ! -f dist/bear-hub ]; then echo "bear-hub missing"; exit 1; fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: bear-hub-linux-executables
        path: dist/

    - name: Upload Release Assets
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./dist/bear-installer
        asset_name: bear-installer
        asset_content_type: application/octet-stream

    - name: Upload Release Assets (Launcher)
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./dist/bear-hub
        asset_name: bear-hub
        asset_content_type: application/octet-stream
