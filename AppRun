#!/bin/bash
set -e

# AppRun is the entry point for the AppImage.
# $APPDIR is the path where the AppImage is mounted.

HERE="$(dirname "$(readlink -f "${0}")")"
export PATH="${HERE}/usr/bin:${PATH}"

# Icon resource (if needed by the app)
export BEAR_HUB_ICON="${HERE}/bear-hub.png"

# Installer/Setup Check
# Check for config or marker
CONFIG_FILE="${HOME}/BEAR-HUB/.bear-hub.env"

if [ ! -f "$CONFIG_FILE" ]; then
    # Try to use zenity for a GUI prompt
    if command -v zenity >/dev/null 2>&1; then
        zenity --info --title="BEAR-HUB Setup" --text="First time setup required.\n\nThis will check for Docker/Conda and create the 'bactopia' environment.\nIt may take a few minutes." --width=400

        # Determine terminal emulator
        TERMINAL_CMD=""
        if command -v x-terminal-emulator >/dev/null 2>&1; then
            TERMINAL_CMD="x-terminal-emulator"
        elif command -v gnome-terminal >/dev/null 2>&1; then
            TERMINAL_CMD="gnome-terminal"
        elif command -v konsole >/dev/null 2>&1; then
            TERMINAL_CMD="konsole"
        elif command -v xterm >/dev/null 2>&1; then
            TERMINAL_CMD="xterm"
        fi

        if [ -n "$TERMINAL_CMD" ]; then
            # We wrap the command in bash -c '...; read' to ensure window stays open
            # We use "${HERE}/usr/bin/bear-installer" explicitly
            INSTALLER_BIN="${HERE}/usr/bin/bear-installer"

            # Complex quoting to handle paths with spaces if any, though inside AppImage usually safe
            CMD="bash -c '\"$INSTALLER_BIN\"; echo; echo \"Process finished.\"; read -p \"Press Enter to close...\"'"

            # gnome-terminal uses -- bash -c ..., others use -e
            if [ "$TERMINAL_CMD" = "gnome-terminal" ]; then
                $TERMINAL_CMD -- bash -c "\"$INSTALLER_BIN\"; echo; echo \"Process finished.\"; read -p \"Press Enter to close...\""
            else
                $TERMINAL_CMD -e bash -c "\"$INSTALLER_BIN\"; echo; echo \"Process finished.\"; read -p \"Press Enter to close...\""
            fi
        else
            # Fallback: run silently and hope, or show error
             zenity --error --text="No terminal emulator found to run setup. Please run the AppImage from a terminal."
             exit 1
        fi

    else
        # No GUI tool, try running installer directly (might fail if no terminal attached)
        "${HERE}/usr/bin/bear-installer"
    fi
fi

# Now run the app
exec "${HERE}/usr/bin/bear-hub" "$@"
